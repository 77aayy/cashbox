# مراجعة نهائية للمنطق والمعادلات — قبل النشر

تاريخ المراجعة: 2026-02-18

## 1. المعادلات الأساسية (`src/lib/utils.ts`)

### بنك نزيل (عرض فقط)
- **الصيغة:** بنك نزيل = مدى + فيزا + ماستر كارد + أمريكان إكسبريس  
- **تحويل بنكي:** للعرض فقط — لا يدخل في بنك نزيل ولا في انحراف البنك ولا في variance عند الإغلاق.

### انحراف البنك
- **الصيغة:** انحراف البنك = بنك نزيل − اجمالى الموازنه  
- **اجمالى الموازنه:** الحقل `programBalanceBank` (يُدخل يدوياً أو يُرحّل من الحاسبة).  
- **الاستخدام:** `computeBankVariance(row)` — يُستخدم في الواجهة ونافذة الشرح والطباعة.

### انحراف الكاش
- **الصيغة:** مصروفات فعّالة = مصروفات − تعويض مصروفات (ولا تقل عن 0)  
  المتوقّع = كاش + مرسل للخزنة + مصروفات فعّالة  
  انحراف الكاش = المتوقّع − رصيد البرنامج كاش  
- **الاستخدام:** `computeCashVariance(row)` — في الواجهة ونافذة الشرح والطباعة.

### إجمالي الانحراف (عند الإغلاق فقط)
- **الصيغة:** المجموع النقدي = كاش + مدى + فيزا + ماستر كارد + أمريكان إكسبريس (بدون تحويل بنكي)  
  رصيد البرنامج الكلي = رصيد البرنامج كاش + اجمالى الموازنه  
  variance = المجموع النقدي − رصيد البرنامج الكلي  
- **الاستخدام:** `computeVariance(row)` — يُحسب عند كل تعديل رقمي ويُخزَّن في الصف، وعند الإغلاق يُمرَّر مع الصف إلى Firebase.

---

## 2. تطابق المعادلات في الكود

| الموقع | بنك نزيل | انحراف البنك | انحراف الكاش | variance |
|--------|----------|--------------|--------------|----------|
| `utils.ts` | — | totalBudget − programBalanceBank | expected − programCash | sum − program (بدون تحويل بنكي) |
| `ClosureRow.tsx` | mada+visa+mastercard+(amex??0) | computeBankVariance(row) | computeCashVariance(row) | — |
| `CashBox.tsx` (طباعة، شرح) | mada+visa+mastercard+(amex??0) | computeBankVariance | computeCashVariance | computeVariance عند التعديل والإغلاق |
| `storage.ts` | — | — | — | يُخزَّن مع الصف |
| `firebaseClosedRows.ts` | — | — | — | يُنسخ مع الصف (amex وكل الحقول) |

---

## 3. أمريكان إكسبريس (Amex)

- **النوع:** `ClosureRow.amex` (رقم) في `types.ts`.  
- **بنك نزيل:** مدى + فيزا + ماستر + **أمريكان إكسبريس**.  
- **انحراف البنك:** يستخدم نفس المجموع (مدى+فيزا+ماستر+amex) − اجمالى الموازنه.  
- **variance عند الإغلاق:** كاش + مدى + فيزا + ماستر + **amex** (بدون تحويل بنكي).  
- **الإكسل:** استخراج عمود أمريكان إكسبريس ودمجه في `sums.amex` و `details.amex`.  
- **حاسبة العمليات البنكية:** ترحيل إلى مدى/فيزا/ماستر/**amex** + اجمالى الموازنه، بأربع قيم.  
- **التخزين و Firebase:** `normalizeRow` و `toClosureRow` يتضمنان `amex`؛ القيم القديمة تُعامل كـ `?? 0` في المعادلات.

---

## 4. تحديث variance عند التعديل

- في `handleUpdate` (CashBox): عند تعديل أي حقل رقمي يُعاد حساب `patch.variance = computeVariance(next)` ويُدمج في الـ patch.  
- عند استيراد الإكسل: `nextRow` يُبنى مع `variance: computeVariance({ ...current, ...filled })`.  
- عند مسح المصروفات/التصنيف: `computeVariance({ ...row, expenses, expenseItems })`.  
- عند الإغلاق: يُمرَّر `{ ...merged, variance: v }` حيث `v = computeVariance(merged)` إلى `closeRow` ثم Firebase.

---

## 5. التعامل مع البيانات القديمة

- في `utils.ts`: جميع المعادلات تستخدم `?? 0` للحقول الرقمية (cash, mada, visa, mastercard, amex, programBalanceCash, programBalanceBank) لتجنّب NaN إذا وُجدت صفوف قديمة بدون amex أو بدون بعض الحقول.  
- `storage.normalizeRow` و `firebaseClosedRows` يضمنان وجود `amex` و programBalanceBank كأرقام عند القراءة.

---

## 6. التحقق المنفذ

- مراجعة نصوص المعادلات في التعليقات والواجهة (انحراف الكاش، انحراف البنك، بنك نزيل، تحويل بنكي للعرض فقط).  
- التأكد من عدم دخول تحويل بنكي في انحراف البنك ولا في variance.  
- التأكد من دخول أمريكان إكسبريس في بنك نزيل وانحراف البنك وvariance.  
- البناء: `npm run build` ناجح.  
- لا أخطاء من اللينتر على الملفات المعدّلة.

---

## 7. جاهزية النشر

- المنطق والمعادلات متسقة في كل الاستخدامات.  
- أمريكان إكسبريس مدمج في الأنواع، الإكسل، التخزين، Firebase، والحاسبة البنكية.  
- التعامل الآمن مع القيم الناقصة يقلل خطر أخطاء عند بيانات قديمة.  

يمكن المتابعة إلى النشر بعد التأكد من إعدادات البيئة (Firebase، النطاق، إلخ).
