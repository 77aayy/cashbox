<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>CashBox Local Tester</title>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f4f4f9; }
    h2, h3 { color: #333; }
    .section { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, select { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
    button { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; }
    button:hover { background: #218838; }
    button.secondary { background: #007bff; }
    button.secondary:hover { background: #0069d9; }
    pre { background: #2d2d2d; color: #83e422; padding: 15px; border-radius: 5px; overflow-x: auto; direction: ltr; text-align: left; }
    .status { font-weight: bold; margin-bottom: 10px; }
    .token-status { font-size: 0.9em; color: #666; margin-top: 5px; }
</style>
</head>
<body>

<h2>ğŸ•µï¸ CashBox Backend Tester (Localhost)</h2>

<div class="section">
    <label>ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ±:</label>
    <input id="apiUrl" value="http://localhost:5000">
    <button class="secondary" onclick="testServer()">ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ (Ping)</button>
</div>

<div class="section">
    <h3>1. Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth)</h3>
    <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <div style="display: flex; gap: 10px;">
        <button onclick="register()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ (Register)</button>
        <button class="secondary" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ (Login)</button>
    </div>
    <div class="token-status" id="tokenDisplay">Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ†: ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ âŒ</div>
</div>

<div class="section">
    <h3>2. Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Box)</h3>
    <input id="boxName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <button onclick="createBox()">Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø¬Ø¯ÙŠØ¯</button>
    <button class="secondary" style="margin-top:5px;" onclick="getMyBoxes()">Ø¬Ù„Ø¨ ØµÙ†Ø§Ø¯ÙŠÙ‚ÙŠ</button>
</div>

<div class="section">
    <h3>3. Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Transaction)</h3>
    <input id="targetBoxId" placeholder="ID Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)">
    <input id="amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·)">
    <input id="desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©">
    <button onclick="addTransaction()">ØªØ³Ø¬ÙŠÙ„ Ø¥ÙŠØ¯Ø§Ø¹ (Deposit)</button>
    <button class="secondary" style="margin-top:5px;" onclick="getTransactions()">Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</button>
</div>

<h3>ğŸ“Ÿ Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Logs):</h3>
<pre id="output">Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</pre>

<script>
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    function log(data) {
        const output = document.getElementById("output");
        if (typeof data === 'object') {
            output.textContent = JSON.stringify(data, null, 2);
        } else {
            output.textContent = data;
        }
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø·
    function getUrl(endpoint) {
        return document.getElementById("apiUrl").value + endpoint;
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    function getToken() {
        return localStorage.getItem('cashbox_token');
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    function updateTokenStatus() {
        const token = getToken();
        const el = document.getElementById("tokenDisplay");
        if(token) {
            el.textContent = "Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ†: Ù…Ø­ÙÙˆØ¸ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… âœ…";
            el.style.color = "green";
        } else {
            el.textContent = "Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ†: ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ âŒ";
            el.style.color = "red";
        }
    }

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    updateTokenStatus();

    // --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ---

    async function testServer() {
        try {
            const res = await fetch(getUrl("/"));
            log(await res.text());
        } catch (err) { log("Error: Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø§ ÙŠØ¹Ù…Ù„! ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„Ù‡."); }
    }

    async function register() {
        const body = {
            username: document.getElementById("username").value,
            password: document.getElementById("password").value
        };
        try {
            const res = await fetch(getUrl("/api/auth/register"), {
                method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body)
            });
            log(await res.json());
        } catch (err) { log(err); }
    }

    async function login() {
        const body = {
            username: document.getElementById("username").value,
            password: document.getElementById("password").value
        };
        try {
            const res = await fetch(getUrl("/api/auth/login"), {
                method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body)
            });
            const data = await res.json();
            log(data);
            
            if (data.token) {
                localStorage.setItem('cashbox_token', data.token);
                updateTokenStatus();
            }
        } catch (err) { log(err); }
    }

    async function createBox() {
        const token = getToken();
        if (!token) return log("Ø®Ø·Ø£: ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");

        const body = { name: document.getElementById("boxName").value };
        
        try {
            const res = await fetch(getUrl("/api/box"), {
                method: "POST",
                headers: { "Content-Type": "application/json", "x-auth-token": token },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            log(data);
            // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ù†Ù†Ø³Ø® Ø§Ù„Ù€ ID Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            if(data.box && data.box._id) {
                document.getElementById("targetBoxId").value = data.box._id;
            }
        } catch (err) { log(err); }
    }

    async function getMyBoxes() {
        const token = getToken();
        if (!token) return log("Ø®Ø·Ø£: ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");

        try {
            const res = await fetch(getUrl("/api/box"), {
                method: "GET", headers: { "x-auth-token": token }
            });
            log(await res.json());
        } catch (err) { log(err); }
    }

    async function addTransaction() {
        const token = getToken();
        if (!token) return log("Ø®Ø·Ø£: ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");

        const body = {
            boxId: document.getElementById("targetBoxId").value,
            amount: Number(document.getElementById("amount").value),
            type: "deposit",
            description: document.getElementById("desc").value
        };

        try {
            const res = await fetch(getUrl("/api/transaction"), {
                method: "POST",
                headers: { "Content-Type": "application/json", "x-auth-token": token },
                body: JSON.stringify(body)
            });
            log(await res.json());
        } catch (err) { log(err); }
    }

    async function getTransactions() {
        const token = getToken();
        const boxId = document.getElementById("targetBoxId").value;
        if (!token) return log("Ø®Ø·Ø£: ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");
        if (!boxId) return log("Ø®Ø·Ø£: ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ ID Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚!");

        try {
            const res = await fetch(getUrl("/api/transaction/" + boxId), {
                method: "GET", headers: { "x-auth-token": token }
            });
            log(await res.json());
        } catch (err) { log(err); }
    }
</script>

</body>
</html>